"""Add candidate results

Revision ID: 2e69eaf6109f
Revises: add_draft_status
Create Date: 2026-01-04 14:18:36.487950

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '2e69eaf6109f'
down_revision: Union[str, Sequence[str], None] = 'add_draft_status'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('candidate_results',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('registration_candidate_id', sa.Integer(), nullable=False),
    sa.Column('subject_id', sa.Integer(), nullable=False),
    sa.Column('registration_exam_id', sa.Integer(), nullable=False),
    sa.Column('grade', sa.Enum('FAIL', 'PASS', 'LOWER_CREDIT', 'CREDIT', 'UPPER_CREDIT', 'DISTINCTION', 'BLOCKED', 'CANCELLED', 'ABSENT', name='grade'), nullable=False),
    sa.Column('is_published', sa.Boolean(), nullable=False),
    sa.Column('published_at', sa.DateTime(), nullable=True),
    sa.Column('published_by_user_id', sa.UUID(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['published_by_user_id'], ['portal_users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['registration_candidate_id'], ['registration_candidates.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['registration_exam_id'], ['registration_exams.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['subject_id'], ['subjects.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('registration_candidate_id', 'subject_id', 'registration_exam_id', name='uq_candidate_subject_exam_result')
    )
    op.create_index(op.f('ix_candidate_results_published_by_user_id'), 'candidate_results', ['published_by_user_id'], unique=False)
    op.create_index(op.f('ix_candidate_results_registration_candidate_id'), 'candidate_results', ['registration_candidate_id'], unique=False)
    op.create_index(op.f('ix_candidate_results_registration_exam_id'), 'candidate_results', ['registration_exam_id'], unique=False)
    op.create_index(op.f('ix_candidate_results_subject_id'), 'candidate_results', ['subject_id'], unique=False)
    op.create_table('result_blocks',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('block_type', sa.Enum('CANDIDATE_ALL', 'CANDIDATE_SUBJECT', 'SCHOOL_ALL', 'SCHOOL_SUBJECT', name='resultblocktype'), nullable=False),
    sa.Column('registration_exam_id', sa.Integer(), nullable=False),
    sa.Column('registration_candidate_id', sa.Integer(), nullable=True),
    sa.Column('school_id', sa.Integer(), nullable=True),
    sa.Column('subject_id', sa.Integer(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('blocked_by_user_id', sa.UUID(), nullable=False),
    sa.Column('reason', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['blocked_by_user_id'], ['portal_users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['registration_candidate_id'], ['registration_candidates.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['registration_exam_id'], ['registration_exams.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['school_id'], ['schools.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['subject_id'], ['subjects.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_result_blocks_block_type'), 'result_blocks', ['block_type'], unique=False)
    op.create_index(op.f('ix_result_blocks_blocked_by_user_id'), 'result_blocks', ['blocked_by_user_id'], unique=False)
    op.create_index(op.f('ix_result_blocks_is_active'), 'result_blocks', ['is_active'], unique=False)
    op.create_index(op.f('ix_result_blocks_registration_candidate_id'), 'result_blocks', ['registration_candidate_id'], unique=False)
    op.create_index(op.f('ix_result_blocks_registration_exam_id'), 'result_blocks', ['registration_exam_id'], unique=False)
    op.create_index(op.f('ix_result_blocks_school_id'), 'result_blocks', ['school_id'], unique=False)
    op.create_index(op.f('ix_result_blocks_subject_id'), 'result_blocks', ['subject_id'], unique=False)
    # op.create_unique_constraint('uq_programme_subject', 'programme_subjects', ['programme_id', 'subject_id'])
    op.add_column('registration_exams', sa.Column('results_published', sa.Boolean(), nullable=False))
    op.add_column('registration_exams', sa.Column('results_published_at', sa.DateTime(), nullable=True))
    op.add_column('registration_exams', sa.Column('results_published_by_user_id', sa.UUID(), nullable=True))
    op.create_index(op.f('ix_registration_exams_results_published'), 'registration_exams', ['results_published'], unique=False)
    op.create_index(op.f('ix_registration_exams_results_published_by_user_id'), 'registration_exams', ['results_published_by_user_id'], unique=False)
    op.create_foreign_key(None, 'registration_exams', 'portal_users', ['results_published_by_user_id'], ['id'], ondelete='SET NULL')
    # op.create_unique_constraint('uq_school_programme', 'school_programmes', ['school_id', 'programme_id'])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    # op.drop_constraint('uq_school_programme', 'school_programmes', type_='unique')
    op.drop_constraint(None, 'registration_exams', type_='foreignkey')
    op.drop_index(op.f('ix_registration_exams_results_published_by_user_id'), table_name='registration_exams')
    op.drop_index(op.f('ix_registration_exams_results_published'), table_name='registration_exams')
    op.drop_column('registration_exams', 'results_published_by_user_id')
    op.drop_column('registration_exams', 'results_published_at')
    op.drop_column('registration_exams', 'results_published')
    # op.drop_constraint('uq_programme_subject', 'programme_subjects', type_='unique')
    op.drop_index(op.f('ix_result_blocks_subject_id'), table_name='result_blocks')
    op.drop_index(op.f('ix_result_blocks_school_id'), table_name='result_blocks')
    op.drop_index(op.f('ix_result_blocks_registration_exam_id'), table_name='result_blocks')
    op.drop_index(op.f('ix_result_blocks_registration_candidate_id'), table_name='result_blocks')
    op.drop_index(op.f('ix_result_blocks_is_active'), table_name='result_blocks')
    op.drop_index(op.f('ix_result_blocks_blocked_by_user_id'), table_name='result_blocks')
    op.drop_index(op.f('ix_result_blocks_block_type'), table_name='result_blocks')
    op.drop_table('result_blocks')
    op.drop_index(op.f('ix_candidate_results_subject_id'), table_name='candidate_results')
    op.drop_index(op.f('ix_candidate_results_registration_exam_id'), table_name='candidate_results')
    op.drop_index(op.f('ix_candidate_results_registration_candidate_id'), table_name='candidate_results')
    op.drop_index(op.f('ix_candidate_results_published_by_user_id'), table_name='candidate_results')
    op.drop_table('candidate_results')
    # ### end Alembic commands ###
